# A Makefile for fusing Google Test and building a sample test against it.
#
# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make check  - makes everything and runs the built sample test.
#   make clean  - removes all files generated by make.

# Points to the root of fused Google Test, relative to where this file is.
OUT_DIR = output

# Paths to the fused gtest files.
FUSED_GTEST_H = $(OUT_DIR)/gtest/gtest.h
FUSED_GTEST_ALL_CC = $(OUT_DIR)/gtest/gtest-all.cc

# Where to find the sample test.
SOURCE_DIR = ../../src

# Where to find gtest_main.cc.
GTEST_MAIN_CC = /usr/local/Cellar/googletest/1.10.0/include/googletest/googletest/src/gtest_main.cc

# Flags passed to the preprocessor.
# We have no idea here whether pthreads is available in the system, so
# disable its use.
CPPFLAGS += -I$(OUT_DIR) -DGTEST_HAS_PTHREAD=0

# Flags passed to the C++ compiler.
CXXFLAGS += -g -std=c++11

SOURCE_DIR := ../../src
OBJECT_DIR := $(OUT_DIR)/object
TEST_OBJECT_DIR := $(OBJECT_DIR)/test


all : test

check : all
	./test

clean :
	rm -rf $(OUT_DIR)

$(FUSED_GTEST_H) :
	../fuse_gtest_files.py /usr/local/Cellar/googletest/1.10.0 $(OUT_DIR)

$(FUSED_GTEST_ALL_CC) :
	../fuse_gtest_files.py /usr/local/Cellar/googletest/1.10.0 $(OUT_DIR)

gtest-all.o : $(FUSED_GTEST_H) $(FUSED_GTEST_ALL_CC)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(OUT_DIR)/gtest/gtest-all.cc

gtest_main.o : $(FUSED_GTEST_H) $(GTEST_MAIN_CC)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(GTEST_MAIN_CC)

key.o : $(SOURCE_DIR)/note/key.cpp $(SOURCE_DIR)/note/key.h
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

key_unittest.o : $(SOURCE_DIR)/note/key_unittest.cc \
                     $(SOURCE_DIR)/note/key.h $(FUSED_GTEST_H)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

chord.o : $(SOURCE_DIR)/note/chord.cpp $(SOURCE_DIR)/note/chord.h
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

chord_unittest.o : $(SOURCE_DIR)/note/chord_unittest.cc \
                     $(SOURCE_DIR)/note/chord.h $(FUSED_GTEST_H)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

note.o : $(SOURCE_DIR)/note/note.cpp $(SOURCE_DIR)/note/note.h
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

note_unittest.o : $(SOURCE_DIR)/note/note_unittest.cc \
                     $(SOURCE_DIR)/note/note.h $(FUSED_GTEST_H)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

test : note.o note_unittest.o key.o key_unittest.o \
					 chord.o chord_unittest.o \
					 gtest-all.o gtest_main.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lgtest $^ -o $@